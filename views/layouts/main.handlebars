<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1 shrink-to-fit=no">
        <title>Flight Search</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.1/dist/css/bootstrap-datepicker3.min.css">
    </head>

    <body class="bg-secondary-subtle text-bg-dark">
        <main class="container-fluid px-5 mt-4">
            {{{body}}}   
        </main>

        <div class="text-center pb-3 text-secondary">
            <small>© 2025 jetBlue Airlines — All Rights Reserved</small>
        </div>

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/5.0.0/js/bootstrap.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            $(document).ready(function() {
                
                // Set minimum dates
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const minDate = `${year}-${month}-${day}`;
                $('#depdate').attr('min', minDate);
                $('#depdate').on('change', function(){
                    let depdate = $(this).val();
                    $('#retdate').attr('min', depdate); 
                });
                
                // Swap Button 
                $('#swap').click(function() {
                    // Get origin and destination values
                    var origin = $('#origin').text().trim();            
                    var destination = $('#destination').text().trim();  

                    // Swap
                    $('#origin').text(destination);  
                    $('#destination').text(origin); 

                    const origVal = $('#searchOrig').val();
                    $('#searchOrig').val($('#searchDest').val());
                    $('#searchDest').val(origVal); 
                });

                // Origin and Destination dropdowns
                $('.origin').on('click', function(){
                    const choice = $(this).text().trim();
                    $('#origin').text(choice);
                    $('#searchOrig').val(choice);
                });
                $('.destination').on('click', function(){
                    const choice = $(this).text().trim();
                    $('#destination').text(choice);
                    $('#searchDest').val(choice);
                });

                // Toggle Dark Button
                $('#toggleDark').click(function() {
                    var currentTheme = $('html').attr('data-bs-theme');         // Get current theme
                    var newTheme = currentTheme === 'dark' ? 'light' : 'dark';  // Check if current theme is dark or light then change
                    $('html').attr('data-bs-theme', newTheme);                  // Insert new theme to page 

                    // Toggle classes to change bootstrap elements in light/dark mode
                    $('#navbarNav').toggleClass('bg-dark-subtle bg-primary-subtle');
                    $('#navbarNav').toggleClass('text-dark-emphasis text-primary-emphasis');
                    $('#toggleDark').toggleClass('bi-sun-fill bi-moon-fill');
                    $('body').toggleClass('text-bg-dark text-bg-light');
                    $('body').toggleClass('bg-secondary-subtle bg-light');
                    $('#form').toggleClass('bg-dark-subtle bg-primary');
                    $('form').toggleClass('bg-dark-subtle bg-primary');
                    $('#swap').toggleClass('btn-primary btn-outline-light');
                    $('#origin').toggleClass('btn-outline-secondary btn-light');
                    $('#destination').toggleClass('btn-outline-secondary btn-light');
                    $('#search').toggleClass('btn-primary btn-outline-light');
                });

                // Check form inputs
                $('#search').click(function(event) {
                    // Get input values
                    let passcount = $('#passcount').val().trim();
                    let origin = $('#origin').text().toLowerCase().trim();
                    let destination = $('#destination').text().toLowerCase().trim();
                    let depdate = new Date($('#depdate').val());
                    let retdate = new Date($('#retdate').val());
                    
                    // Error strings
                    const fillError = `Please fill in all fields except return date.`;
                    const locError = `Origin and Destination cannot be the same`;
                    
                    // Check required fields
                    if (origin === `Where from?` || destination === `Where to?` || isNaN(depdate.getTime())) {     
                        event.preventDefault();
                        $("#errorText").html(fillError);
                        let formModal = new bootstrap.Modal(document.getElementById('formModal'));
                        formModal.show();
                    } 
                    // Check same location
                    else if (origin && destination && (origin == destination)){       
                        event.preventDefault();
                        $("#errorText").html(locError);
                        let formModal = new bootstrap.Modal(document.getElementById('formModal'));
                        formModal.show();
                    } 
                    // Success
                    else {      
                        $("#tableBody").empty();
                        $('#resultsText').fadeIn(1000);
                        $('#searchCont').fadeIn(1000);
                    }
                });

                // Hide search container on form container mouse enter
                //$('#formContainer').on('mouseenter', function() {
                  //  $('#resultsText').fadeOut(1000);
                   // $('#searchCont').fadeOut(1000);
                   // $('html, body').animate({ scrollTop: 0 }, 'fast'); // scroll to top
                //});

                let dSelected = null;
                let rSelected = null;

                $(document).on('click', '.select-btn', function() {
                    const isSelected = $(this).text() === 'Selected';
                    const type = $(this).data('type'); // departure or return
                    const row = $(this).closest('tr');
                    
                    const flight = {
                        airline: row.find('td:eq(0)').text(),
                        flightNo: row.find('td:eq(1)').text(),
                        depart: row.find('td:eq(2)').text(),
                        arrive: row.find('td:eq(3)').text(),
                        price: row.find('td:eq(4)').text()
                    };
                    
                    
                    const offcanvas = new bootstrap.Offcanvas('#summaryOffcanvas');
                    offcanvas.show();

                    $('#summaryBody').text(''); // Clear previous summary

                    // Get origin and destination from data attributes
                    const origin = $(this).data('origin');
                    const destination = $(this).data('destination');

                    if (type === 'depart') {
                        dSelected = flight;
                        $('.depart-flight .select-btn').removeClass('btn-outline-success').addClass('btn-primary').text('Select');
                        $(this).removeClass('btn-primary').addClass('btn-outline-success').text('Selected');

                        // Create summary content
                        let dSummaryContent = `
                            <h5>Flight Summary | <small>${origin} <i class="text-primary bi bi-airplane-fill"></i> ${destination}</small></h5>
                            <hr>
                            <p><strong class="text-primary">Airline:</strong> ${dSelected.airline}</p>
                            <p><strong class="text-primary">Flight Number:</strong> ${dSelected.flightNo}</p>
                            <p><strong class="text-primary">Departure Time:</strong> ${dSelected.depart}</p>
                            <p><strong class="text-primary">Arrival Time:</strong> ${dSelected.arrive}</p>
                            <p><strong class="text-primary">Price:</strong> ${dSelected.price}</p>
                            <hr>
                            <a href="/book" class="btn btn-success w-100">Proceed to Booking</a>
                        `;

                        // Append summary content to offcanvas body
                        $('#summaryBody').html(dSummaryContent);
                    } else {
                        rSelected = flight;
                        $('.return-flight .select-btn').removeClass('btn-outline-success').addClass('btn-primary').text('Select');
                        $(this).removeClass('btn-primary').addClass('btn-outline-success').text('Selected');

                        // Create summary content
                        const rSummaryContent = `
                            <h5>Returning Flight | <small>${origin} <i class="text-primary bi bi-airplane-fill"></i> ${destination}</small></h5>
                            <hr>
                            <p><strong class="text-primary">Airline:</strong> ${rSelected.airline}</p>
                            <p><strong class="text-primary">Flight Number:</strong> ${rSelected.flightNo}</p>
                            <p><strong class="text-primary">Departure Time:</strong> ${rSelected.depart}</p>
                            <p><strong class="text-primary">Arrival Time:</strong> ${rSelected.arrive}</p>
                            <p><strong class="text-primary">Price:</strong> ${rSelected.price}</p>
                            <hr>
                            <a href="/book" class="btn btn-success w-100">Proceed to Booking</a>
                        `;

                        // Append summary content to offcanvas body
                        $('#summaryBody').html(rSummaryContent);
                    }

                    if (dSelected && rSelected) {
                        const offcanvas = new bootstrap.Offcanvas('#summaryOffcanvas');
                        offcanvas.show();

                        $('#summaryBody').html(`
                            <h5>Departure Flight | <small>${$('#origin').text().trim()} <i class="text-primary bi bi-airplane-fill"></i> ${$('#destination').text().trim()}</small></h5>
                            <hr>
                            <p><strong class="text-primary">Airline:</strong> ${dSelected.airline}</p>
                            <p><strong class="text-primary">Flight Number:</strong> ${dSelected.flightNo}</p>
                            <p><strong class="text-primary">Departure Time:</strong> ${dSelected.depart}</p>
                            <p><strong class="text-primary">Arrival Time:</strong> ${dSelected.arrive}</p>
                            <p><strong class="text-primary">Price:</strong> ${dSelected.price}</p>
                            <hr>
                            <h5>Return Flight | <small>${$('#destination').text().trim()} <i class="text-primary bi bi-airplane-fill"></i> ${$('#origin').text().trim()}</small></h5>
                            <hr>
                            <p><strong class="text-primary">Airline:</strong> ${rSelected.airline}</p>
                            <p><strong class="text-primary">Flight Number:</strong> ${rSelected.flightNo}</p>
                            <p><strong class="text-primary">Departure Time:</strong> ${rSelected.depart}</p>
                            <p><strong class="text-primary">Arrival Time:</strong> ${rSelected.arrive}</p>
                            <p><strong class="text-primary">Price:</strong> ${rSelected.price}</p>
                            <hr>
                            <a href="/book" class="btn btn-success w-100">Proceed to Booking</a>
                        `);
                    }

                    // If clicked button is already selected
                    if (isSelected) {
                        const offCanvas = bootstrap.Offcanvas.getInstance(document.getElementById('summaryOffcanvas'));
                        if (offCanvas) {
                            offCanvas.hide();
                        }
                        return;
                    }
                });

                const msg = $('.form-msg');
                const title = $('#title');
                const flightList = $('#flight-list');
                if (msg.length) {
                    title.removeClass('mt-5');
                    setTimeout(() => {msg.alert('close'); }, 3000); // hides after 3 seconds

                    msg.on('closed.bs.alert', function () {
                        title.addClass('mt-5');
                    });
                } else {
                    $('#title').addClass('mt-5');
                }

                // Handle departure and arrival day dropdowns in flight management
                const depDay = $('#departureDay').val();
                const arrDay = $('#arrivalDay').val();

                if (depDay) {
                    $('#editDepDay').text(depDay);
                    $('#editDepartureDay').val(depDay);
                }

                if (arrDay) {
                    $('#editArrDay').text(arrDay);
                    $('#editArrDay').val(arrDay);
                } 
                $('.depDay').on('click', function(){
                        let choice = $(this).text().trim();
                        $('#depDay').text(choice);
                        $('#editDepDay').text(choice);
                        $('#departureDay').val(choice);
                        $('#editDepartureDay').val(choice);
                });

                $('.arrDay').on('click', function(){
                        let choice = $(this).text().trim();
                        $('#arrDay').text(choice);
                        $('#editArrDay').text(choice);
                        $('#arrivalDay').val(choice);
                        $('#editArrivalDay').val(choice);
                });
            });
        </script>
    </body>
</html>
