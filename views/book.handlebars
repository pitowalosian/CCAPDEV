{{! navbar }}
<div class="container-fluid fixed-top">
    <div class="navbar fixed-top bg-dark-subtle border-bottom border-primary" id="navbarNav">
        <a class="navbar-brand" href="/"><img height="40" src="/pictures/icon.png"/></a>
        <ul class="nav nav-pills nav-fill">
            <li class="nav-item">
                <a class="nav-link" href="/flights">Flight Management</a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="/book">Book Flights</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/reservations">My Reservations</a>
            </li>
        </ul>
    </div>
</div>

{{! header }}
<div class="container text-center pt-5 mt-5">
    <h1 class="display-5 text-center text-primary">Book Flights</h1>
    <p class="lead">Answer the reservation form to book your flight</p>
</div>

{{! form }}
<div class="container mt-4 mb-5 position pt-2 shadow-lg rounded-3 bg-dark-subtle border border-primary" id="form-p1">
    <div class="container mt-4 mb-4 justify-content-center">
        <form id="passengerInfo" action="/reservations" method="POST">
            <input type="hidden" name="tripType" id="tripType" value="Round-trip">
            <input type="hidden" name="travelClass" id="travelClass" value="Economy">
            <input type="hidden" name="adults" id="adults" value="1">
            <input type="hidden" name="children" id="children" value="0">
            <input type="hidden" name="infants" id="infants" value="0">
            <input type="hidden" name="seat" id="selectedSeat" required>
            <input type="hidden" name="phoneNum" id="phoneNumHidden" value="">

            {{! flight selection }}
            <div class="row justify-content-center mb-4">
                <div class="col-md-8">
                    <label for="flightId" class="form-label h5">Select Flight *</label>
                    <select class="form-control" name="flightId" id="flightId" required>
                        <option value="">Choose a flight...</option>
                        {{#each flights}}
                        <option value="{{this._id}}">
                            {{this.airline}} {{this.flightNo}} - {{this.origin}} to {{this.destination}}
                        </option>
                        {{/each}}
                    </select>
                </div>
            </div>

            {{! passenger details }}
            <fieldset class="form-section">
                <div class="row justify-content-center mb-3">
                    <div class="col-md-6">
                        <legend class="h5 text-left pb-2">Personal Information</legend>
                    </div>
                    
                    {{! buttons }}
                    <div class="col-md-6">
                        <div class="buttons text-left" type="button">
                            {{! trip type }}
                            <button type="button" class="btn btn-primary me-2 dropdown-toggle" id="button1" data-bs-toggle="dropdown">Round-Trip</button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" value="3000" href="#">Round-trip</a></li>
                                <li><a class="dropdown-item" value="2000" href="#">One-way</a></li>
                                <li><a class="dropdown-item" value="5000" href="#">Multi-city</a></li>
                            </ul>

                            {{! passenger count }}
                            <button type="button" class="btn btn-primary me-2 dropdown-toggle" id="button2" data-bs-toggle="modal" data-bs-target="#passengersCount">1 Adult</button>

                            {{! travel classes }}
                            <button type="button" class="btn btn-primary me-2 dropdown-toggle" id="button3" data-bs-toggle="dropdown">Economy</button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" value="10000" href="#">Economy</a></li>
                                <li><a class="dropdown-item" value="20000" href="#">Premium Economy</a></li>
                                <li><a class="dropdown-item" value="30000" href="#">Business</a></li>
                                <li><a class="dropdown-item" value="60000" href="#">First Class</a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                {{! passenger personal info }}
                <div class="row justify-content-center mb-3">
                    <div class="col-md-6">
                        <label for="fullName" class="form-label">Full name *</label>
                        <input type="text" class="form-control" id="fullName" name="passengerName" required>
                    </div>
                    <div class="col-md-6">
                        <label for="emailAdd" class="form-label">Email *</label>
                        <input type="email" class="form-control" id="emailAdd" name="passengerEmail" required>
                    </div>
                </div>
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <label for="phoneNumInput" class="form-label">Phone No. *</label>
                        <input type="tel" class="form-control" id="phoneNumInput" required>
                    </div> 
                    <div class="col-md-6">
                        <label for="passNum" class="form-label">Passport No. *</label>
                        <input type="text" class="form-control" id="passNum" name="passport" required>
                    </div>
                </div>
            </fieldset>

            {{! optional packages selection }}
            <fieldset class="form-section">
                <legend class="h5 text-left pt-5 pb-3">Preferences</legend>
                <div class="row justify-content-center align-items-start">
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="meal" class="form-label">Meal Options</label>
                            <select class="form-select" id="meal" name="meal">
                                <option value="Standard (included)" selected>Standard (included)</option>
                                <option value="Vegetarian">Vegetarian</option>
                                <option value="Vegan">Vegan</option>
                                <option value="Halal">Halal</option>
                                <option value="Kosher">Kosher</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="baggageWeight" class="form-label">Baggage Weight</label>
                            
                            {{! baggage weight input with kg suffix }}
                            <div class="input-group">
                                <input type="number" class="form-control" id="baggageWeight" 
                                    min="0" max="50" step="0.1" value="0" 
                                    placeholder="Enter total weight">
                                <span class="input-group-text">kg</span>
                            </div>
                            
                            {{! excess baggage info }}
                            <div class="mt-2">
                                <small class="text-muted">
                                    Free Allowance: 20kg <br>
                                    Excess baggage: ₱250 per kg over free allowance
                                </small>
                            </div>
                            
                            {{! display calculated excess }}
                            <div id="excessBaggageInfo" class="mt-2" style="display: none;">
                                <span class="text-danger fw-semibold">
                                    Excess: <span id="excessWeight">0</span>kg (+₱<span id="excessCost">0</span>)
                                </span>
                            </div>
                        </div>
                    </div>

                </div>
            </fieldset>

            {{! seat map selection }}
            <div class="row justify-content-center" id="seatSelection">
                <legend class="h5 text-left pt-5 pb-3">Seat Selection</legend>
                
                {{! first class }}
                <p class="text-center text-primary-emphasis lead fw-medium" id="firstClass">First Class</p>
                <div class="d-flex justify-content-center flex-wrap px-5 mx-5">
                    <div id="firstSeatMap"></div>
                </div>

                {{! business class }}
                <p class="text-center text-info-emphasis lead fw-medium" id="businessClass">Business</p>
                <div class="d-flex justify-content-center flex-wrap px-5 mx-5">
                    <div id="businessSeatMap"></div>
                </div>

                {{! premium economy }}
                <p class="text-center text-warning-emphasis lead fw-medium" id="epClass">Premium Economy</p>
                <div class="d-flex justify-content-center flex-wrap px-5 mx-5">
                    <div id="epSeatMap"></div>
                </div>

                {{! economy }}
                <p class="text-center text-success-emphasis lead fw-medium" id="economyClass">Economy</p>
                <div class="d-flex justify-content-center flex-wrap px-5 mx-5">
                    <div id="economySeatMap"></div>
                </div>

                {{! seat legend }}
                <div class="container d-flex justify-content-center px-5 mx-5">
                    <div class="row">
                        <div class="row justify-content-center m-1">
                            <div class="col-auto">
                                <button class="btn border-0 disabled">
                                    <i class="bi bi-square-fill"></i>
                                </button>
                            </div>
                            <div class="col-auto">
                                <button class="btn border-0">
                                    <i class="bi bi-square-fill text-danger"></i>
                                </button>
                            </div>
                            <div class="col-auto">
                                <button class="btn border-0">
                                    <i class="bi bi-square-fill available-color"></i>
                                </button>
                            </div>
                        </div>
                        <div class="row justify-content-center m-1">
                            <div class="col-auto">
                                <span>Reserved</span>
                            </div>
                            <div class="col-auto">
                                <span class="text-danger">Selected</span>
                            </div>
                            <div class="col-auto">
                                <span class="available-color">Available</span>
                            </div>
                        </div>
                    </div>
                </div>

                {{! submit button }}
                <div class="text-end pt-3">
                    <button type="submit" class="btn btn-primary" id="submitForm">Submit</button>
                </div>

                <p id="error" class="text-danger p-2 justify-content-center"></p>
            </div>  
        </form>
    </div>
</div>

{{! modal for passengers count }}
<div class="modal fade text-center" id="passengersCount" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-dark-subtle">
                <h5 class="modal-title">Passenger Count</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="container justify-content-center border border-primary rounded-3 p-2">
                    <div class="row">
                        <div class="col-4 border-end p-3">
                            <label for="adultCount" class="form-label">Adults</label>
                            <input type="number" class="form-control" id="adultCount" min="1" max="20" value="1">
                        </div>
                        <div class="col-4 border-end p-3">
                            <label for="childrenCount" class="form-label">Children</label>
                            <input type="number" class="form-control" id="childrenCount" min="0" max="20">
                        </div>
                        <div class="col-4 p-3">
                            <label for="infantCount" class="form-label">Infants</label>
                            <input type="number" class="form-control" id="infantCount" min="0" max="20">
                        </div>
                    </div>
                </div>
                <p id="errorText" class="text-danger p-2 justify-content-center"></p>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="submitPassCount">Submit</button>
            </div>
        </div>
    </div>
</div>

{{! modal for summary }}
<div class="modal fade" id="summary" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark-subtle border border-primary">
            <div class="modal-header bg-dark-subtle">
                <h5 class="modal-title text-primary">Booking Summary</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="row text-left p-2">
                    <p id="summaryText"></p>
                    <h5 class="text-primary">Total: ₱<span id="totalCost"></span></h5>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="submitSummary">Proceed to Checkout</button>
            </div>
        </div>
    </div>
</div>


<script>
    $(document).ready(function() {
        let adults = 1;
        let children = 0;
        let infants = 0;
    
        let passCount = adults + children + infants;
        let tripTypeCost = 0;
        let travelClassCost = 0;

        //cost equivalent of passengers depending on type
        const adultCost = 4000;
        const childCost = 2000;
        const infantCost = 1000;

        //default show economy seat selection
        $('#firstClass, #firstSeatMap, #businessClass, #businessSeatMap, #epClass, #epSeatMap').hide();
        $('.available-color').addClass('text-success');
        $('.available-color').removeClass('text-info opacity-75 text-primary text-warning');
        $('#economyClass').show();
        $('#economySeatMap').show();

        let selectedSeats = [];
        seatMap();

        function seatMap() {
            
            // First Class
            for (let i = 0; i < 2; i++) {
                let row = $('<div class="d-flex justify-content-center g-0 m-1"></div>');


                // leftmost seats
                for (let j = 0; j < 1; j++) {
                    let seat = `<div class="col-auto">
                                    <button class="btn border-0 disabled">
                                        <i class="seat bi bi-square-fill" data-row="${i+1}" data-col="${j+1}" data-class="FA"></i>
                                    </button>
                                </div>`;
                    row.append(seat);
                }

                // aisle 
                row.append(`<div class="col-1"></div>`);
                
                // middle seats
                for (let j = 0; j < 2; j++) {
                    let seat = `<div class="col-auto">
                                    <button class="btn border-0">
                                        <i class="seat bi bi-square-fill text-primary" data-row="${i+1}" data-col="${j+1}" data-class="FB"></i>
                                    </button>
                                </div>`;
                    row.append(seat);
                }

                // aisle 
                row.append(`<div class="col-1"></div>`);
                
                // rightmost seats
                for (let j = 0; j < 1; j++) {
                    let seat = `<div class="col-auto">
                                    <button class="btn border-0">
                                        <i class="seat bi bi-square-fill text-primary" data-row="${i+1}" data-col="${j+1}" data-class="FC"></i>
                                    </button>
                                </div>`;
                    row.append(seat);
                }

                $('#firstSeatMap').append(row);
            }

            // Business
            for (let i = 0; i < 5; i++) {
                let row = $('<div class="d-flex justify-content-center g-0 mb-1"></div>');

                // left pair
                for (let j = 0; j < 2; j++) {
                    let seat = `<div class="col-auto">
                                    <button class="btn border-0">
                                        <i class="seat bi bi-square-fill text-info opacity-75" data-row="${i+1}" data-col="${j+1}" data-class="BA"></i>
                                    </button>
                                </div>`;
                    row.append(seat);
                }

                // aisle 
                row.append(`<div class="col-1"></div>`);

                // middle trio
                for (let j = 0; j < 3; j++) {
                    let seat = `<div class="col-auto">
                                    <button class="btn border-0">
                                        <i class="seat bi bi-square-fill text-info opacity-75" data-row="${i+1}" data-col="${j+1}" data-class="BB"></i>
                                    </button>
                                </div>`;
                    row.append(seat);
                }

                // aisle 
                row.append(`<div class="col-1"></div>`);
                
                // right pair
                for (let j = 0; j < 2; j++) {
                    let seat = `<div class="col-auto">
                                    <button class="btn border-0">
                                        <i class="seat bi bi-square-fill text-info opacity-75" data-row="${i+1}" data-col="${j+1}" data-class="BC"></i>
                                    </button>
                                </div>`;
                    row.append(seat);
                }

                $('#businessSeatMap').append(row);
            }

            // Premium Economy
            for (let i = 0; i < 6; i++) {
                let row = $('<div class="d-flex justify-content-center g-0 m-1"></div>');

                // left pair
                for (let j = 0; j < 2; j++) {
                    let seat = `<div class="col-auto">
                                    <button class="btn border-0">
                                        <i class="seat bi bi-square-fill text-warning" data-row="${i+1}" data-col="${j+1}" data-class="PA"></i>
                                    </button>
                                </div>`;
                    row.append(seat);
                }

                // aisle 
                row.append(`<div class="col-1"></div>`);
                
                // middle seats
                for (let j = 0; j < 4; j++) {
                    let seat = `<div class="col-auto">
                                    <button class="btn border-0">
                                        <i class="seat bi bi-square-fill text-warning" data-row="${i+1}" data-col="${j+1}" data-class="PB"></i>
                                    </button>
                                </div>`;
                    row.append(seat);
                }

                // aisle 
                row.append(`<div class="col-1"></div>`);
                
                // right pair
                for (let j = 0; j < 2; j++) {
                    let seat = `<div class="col-auto">
                                    <button class="btn border-0">
                                        <i class="seat bi bi-square-fill text-warning" data-row="${i+1}" data-col="${j+1}" data-class="PC"></i>
                                    </button>
                                </div>`;
                    row.append(seat);
                }

                $('#epSeatMap').append(row);
            }

            // Economy
            for (let i = 0; i < 10; i ++) {
                let row = $('<div class="d-flex justify-content-center g-0 m-1"></div>');

                // left trio
                for (let j = 0; j < 3; j++) {
                    let seat = `<div class="col-auto">
                                    <button class="btn border-0">
                                        <i class="seat bi bi-square-fill text-success" data-row="${i+1}" data-col="${j+1}" data-class="EA"></i>
                                    </button>
                                </div>`;
                    row.append(seat);
                }

                // aisle 
                row.append(`<div class="col-1"></div>`);

                // middle trio
                for (let j = 0; j < 3; j++) {
                    let seat = `<div class="col-auto">
                                    <button class="btn border-0">
                                        <i class="seat bi bi-square-fill text-success" data-row="${i+1}" data-col="${j+1}" data-class="EB"></i>
                                    </button>
                                </div>`;
                    row.append(seat);
                }

                // aisle 
                row.append(`<div class="col-1"></div>`);
                
                // right trio
                for (let j = 0; j < 3; j++) {
                    let seat = `<div class="col-auto">
                                    <button class="btn border-0">
                                        <i class="seat bi bi-square-fill text-success" data-row="${i+1}" data-col="${j+1}" data-class="EC"></i>
                                    </button>
                                </div>`;
                    row.append(seat);
                }

                $('#economySeatMap').append(row);
            }

            // Seat on hover
            $('.seat').hover(function(e) {
                e.preventDefault();
                $(this).toggleClass('opacity-75 opacity-50');
            });
            
            // Seat on click
            $('.seat').click(function(e) {
                e.preventDefault();
                $(this).toggleClass('text-danger');

                let row = $(this).data('row');
                let col = $(this).data('col');
                let seatClass = $(this).data('class');
                let seatCode = seatClass + row + col;

                if ($(this).hasClass('text-danger')) {
                    selectedSeats.push(seatCode); // add if selected
                } else {
                    selectedSeats = selectedSeats.filter(s => s !== seatCode); // remove if unselected
                }
            });
            
        }

        $('#toggleDark').click(function() {
            var currentTheme = $('html').attr('data-bs-theme');
            var newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            $('html').attr('data-bs-theme', newTheme);

            $('#navbarNav').toggleClass('bg-dark-subtle bg-primary-subtle');
            $('#navbarNav').toggleClass('text-dark-emphasis text-primary-emphasis');
            $('#toggleDark').toggleClass('bi-sun-fill bi-moon-fill');
            $('body').toggleClass('text-bg-dark text-bg-light');
            $('body').toggleClass('bg-secondary-subtle bg-light');
        });

        $('.dropdown-item').click(function(){
            let choice = $(this).text().trim(); 
            let cost = parseInt($(this).attr('value')) || 0; //get cost
            
            //find the button with this choice
            if (['Round-trip', 'One-way', 'Multi-city'].includes(choice)) {
                buttonClicked = '#button1';
                tripTypeCost = cost;
            } else {
                buttonClicked = '#button3'
                travelClassCost = cost;
            }

            $(buttonClicked).text(choice); //replace button text
            
            if (buttonClicked == '#button3') {
                $('#firstClass').hide();
                $('#firstSeatMap').hide();
                $('#businessClass').hide();
                $('#businessSeatMap').hide();
                $('#epClass').hide();
                $('#epSeatMap').hide();
                $('#economyClass').hide();
                $('#economySeatMap').hide();
                $('#seatSelection').show();
                
                switch (choice) {
                    case "First Class": 
                        $('.available-color').addClass('text-primary');
                        $('.available-color').removeClass('text-info opacity-75 text-warning text-success');
                        $('#firstClass').show();
                        $('#firstSeatMap').show();
                        break;
                    case "Business":
                        $('.available-color').addClass('text-info opacity-75');
                        $('.available-color').removeClass('text-primary text-warning text-success');
                        $('#businessClass').show();
                        $('#businessSeatMap').show();
                        break;
                    case "Premium Economy":
                        $('.available-color').addClass('text-warning');
                        $('.available-color').removeClass('text-info opacity-75 text-primary text-success');
                        $('#epClass').show();
                        $('#epSeatMap').show();
                        break;
                    case "Economy":
                        $('.available-color').addClass('text-success');
                        $('.available-color').removeClass('text-info opacity-75 text-primary text-warning');
                        $('#economyClass').show();
                        $('#economySeatMap').show();
                        break;
                }
            }
        });

        $('.passengersCount').click(function(){
            let passCountModal = new bootstrap.Modal(document.getElementById('passengersCount'));
            passCountModal.show();
        });

        $('#submitPassCount').click(function(){
            adults = parseInt($('#adultCount').val() || 0); //if input empty, return 0
            children = parseInt($('#childrenCount').val() || 0);
            infants = parseInt($('#infantCount').val() || 0);
            let passCount = adults + children + infants;

            if (passCount > 20) {
                $('#errorText').text("Passengers cannot exceed 20.");
                return;
            } else if (passCount < 1) {
                $('#errorText').text("There must be at least 1 passenger.");
                return;
            } else if (adults == 0) {
                $('#errorText').text("There must be at least 1 adult passenger.");
                return;
            } else {
                $('#errorText').text("");
            }

            $('#button2').text(passCount + ' Traveller' + (passCount > 1 ? 's' : ''));
            
            let passCountInstance = bootstrap.Modal.getInstance(document.getElementById('passengersCount')); //get same modal instance
            passCountInstance.hide(); //close modal
        });

        $('#baggage').change(function(){
            if ($(this).is(':checked')) {
                $('#weight').val(5); // default set to 5kg
            } else {
                $('#weight').val('');
            }

        });

        $('#submitForm').click(function(){

            $('#error').empty();
            const errorsArray = [];

            let passName = $("#fullName").val().trim();
            let email = $("#emailAdd").val().trim();
            let phoneNum = $("#phoneNum").val().trim();
            let passNum = $("#passNum").val().trim();

            let tripType = $("#button1").text().trim();
            let passCount = parseInt($('#button2').text());
            let travelClass = $("#button3").text().trim();
            let mealOption = $("#meal option:selected").text().trim();
            let extraBaggage = $("#baggage").is(":checked");
            let baggageWeight = parseInt($("#weight").val()) || 0;
            let availed = '';

            //costs
            let passCost = (adults * adultCost) + (children * childCost) + (infants *infantCost);
            let mealCost = parseInt($("#meal option:selected").val());
            let baggageCost = extraBaggage ? (baggageWeight / 5) * 250: 0;
            let typeCost = tripTypeCost;
            let classCost = travelClassCost;

            const finalTypeCost = typeCost * passCount;
            const finalClassCost = classCost * passCount;

            if (extraBaggage) {
                if (baggageWeight > 0) {
                    availed =  `Yes (${baggageWeight} kg)`;
                }
            } else {
                availed = "No";
            }

            //validation rules
            if (!/^[a-zA-Z ]{2,}$/.test(passName)) {
                errorsArray.push("Name must include at least two letters and contain only letters.");
            } 
            
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                errorsArray.push("Please enter a valid email address.");
            } 
            
            if (!/^\d{11}$/.test(phoneNum)){
                errorsArray.push("Please enter a valid phone number.");
            }
            
            if (!/^P\d{7}$/.test(passNum)) {
                errorsArray.push("Please enter a valid passport number.");
            }
            
            if (selectedSeats.length != passCount) {
                errorsArray.push(`You can only select ${passCount} seat${passCount > 1 ? 's' : ''}.`);
            }

            if (errorsArray.length > 0) {
                $('#error').html(`<div class="error">${errorsArray.join('<br>')}</div>`);
                return;
            } else {
                $('#error').text('');
            }


            //summary string
            let summary =`<b>Passenger Name:</b> ${passName} <br>
            <b>Email: </b> ${email} <br>
            <b>Phone Number: </b> ${phoneNum} <br>
            <b>Passport Number: </b> ${passNum} <br>
            <hr>

            <b>Trip Type: </b> ${tripType} <br>
            <b>Number of Passengers: </b> ${passCount} (${adults} adult${adults != 1 ? 's' : ''}, 
            ${children} child${children != 1 ? 'ren':''}, 
            ${infants} infant${infants != 1 ? 's':''}) <br>
            <b>Travel Class: </b> ${travelClass} <br>

            <hr>

            <b>Meal Option: </b> ${mealOption} <br>
            <b>Availed for extra baggage: </b> ${availed} <br>
            <b>Seat Number/s: </b> ${selectedSeats.join(', ')} <br>

            <hr>

            <b>Trip Type Cost: </b> ${tripTypeCost} <br>
            <b>Passenger/s Cost: </b> ${passCost} <br>
            <b>Travel Class Cost: </b> ${travelClassCost} <br>
            <b>Meal Cost: </b> ${mealCost} <br>
            <b>Baggage Cost: </b> ${baggageCost} <br>

            <br>`;

            let total = tripTypeCost + travelClassCost + passCost + mealCost + baggageCost;
            let totalString = total.toLocaleString();

            $('#summaryText').html(summary);
            $('#totalCost').html(totalString);

            let summaryModal = new bootstrap.Modal(document.getElementById('summary'));
            summaryModal.show();
        });
        
    });

</script>
    